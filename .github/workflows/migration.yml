# =============================================================================
# Database Migration Workflow
# =============================================================================
# Migration ファイルに変更があった場合のみ自動実行
#
# 対象:
#   - Backend: backend-clean/migrations/** (golang-migrate)
#   - Frontend: frontend/drizzle/** (Drizzle Kit)
#
# 必要な GitHub Secrets:
#   - DATABASE_URL: Neon PostgreSQL 接続文字列
# =============================================================================

name: Database Migration

on:
  push:
    branches:
      - main
    paths:
      # Backend migrations (golang-migrate)
      - "backend-clean/migrations/**"
      # Frontend migrations (Drizzle)
      - "frontend/drizzle/**"
      - "frontend/src/external/client/database/schema.ts"
      # Workflow 自体の変更
      - ".github/workflows/migration.yml"
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      target:
        description: 'Migration target'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend

jobs:
  # ===========================================================================
  # どの migration を実行するか判定
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend-clean/migrations/**'
              - '.github/workflows/migration.yml'
            frontend:
              - 'frontend/drizzle/**'
              - 'frontend/src/external/client/database/schema.ts'
              - '.github/workflows/migration.yml'

      # 手動実行の場合は input を優先
      - name: Override for manual trigger
        id: override
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            case "${{ github.event.inputs.target }}" in
              "backend")
                echo "backend=true" >> $GITHUB_OUTPUT
                echo "frontend=false" >> $GITHUB_OUTPUT
                ;;
              "frontend")
                echo "backend=false" >> $GITHUB_OUTPUT
                echo "frontend=true" >> $GITHUB_OUTPUT
                ;;
              "all")
                echo "backend=true" >> $GITHUB_OUTPUT
                echo "frontend=true" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

  # ===========================================================================
  # Backend Migration (golang-migrate)
  # ===========================================================================
  backend-migration:
    name: Backend Migration
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # golang-migrate をインストール
      - name: Install golang-migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate
          migrate -version

      # Migration 実行
      - name: Run Backend Migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running backend migrations..."
          migrate -path backend-clean/migrations \
                  -database "$DATABASE_URL" \
                  up
          echo "Backend migration completed!"

      - name: Summary
        run: |
          echo "## Backend Migration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool**: golang-migrate" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: backend-clean/migrations" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Frontend Migration (Drizzle Kit)
  # ===========================================================================
  frontend-migration:
    name: Frontend Migration
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: "9"

      - name: Install dependencies
        run: pnpm install
        working-directory: frontend

      # Migration 実行
      - name: Run Frontend Migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running frontend migrations..."
          pnpm db:migrate
          echo "Frontend migration completed!"
        working-directory: frontend

      - name: Summary
        run: |
          echo "## Frontend Migration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool**: Drizzle Kit" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: frontend/drizzle" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
