# バッチ処理入門

「バッチ処理って何？」という人向けの入門ドキュメントです。

---

## バッチ処理とは？

**まとめて処理すること**です。

普段使っている Web アプリは、ボタンを押したらすぐ結果が返ってきます。
でも、すべての処理がそうである必要はありません。

```
例: ECサイト

【すぐ結果が必要な処理】
- 商品を検索する → 検索結果をすぐ見たい
- カートに入れる → 入ったか確認したい
- 購入する → 完了画面を見たい

【後でまとめてやればいい処理】
- 昨日の売上を集計する
- 1ヶ月ログインしてない人にメールを送る
- 古いログを削除する
```

後者のような「後でまとめてやればいい処理」がバッチ処理です。

---

## なぜバッチ処理が必要？

### 理由1: 時間がかかる処理がある

```
「全ユーザー（100万人）の購入履歴を集計して」

→ 1人あたり 0.01秒でも、100万人で 10,000秒（約3時間）
→ ボタン押して3時間待つのは無理
→ 夜中に自動で動かそう
```

### 理由2: サーバーの負荷を分散したい

```
昼間: みんながサイトを使っている
     → サーバーは忙しい
     → 重い処理を動かすと遅くなる

夜中: 誰も使っていない
     → サーバーは暇
     → 重い処理を動かすチャンス
```

### 理由3: 定期的にやりたい処理がある

```
- 毎日: 昨日のアクセスログを集計
- 毎週: 週間レポートを生成
- 毎月: 請求書を発行
```

これを人間が毎回手動でやるのは大変。自動化したい。

---

## バッチ処理の動かし方

### パターン1: 決まった時間に動かす（定期実行）

一番よくあるパターンです。

```
毎日 午前3時に実行
↓
┌─────────────┐
│ バッチ処理  │
│             │
│ 「90日以上  │
│  ログイン   │
│  してない人 │
│  を無効化」 │
└─────────────┘
```

**使う場面:**
- 日次の売上集計
- 月末の請求処理
- 古いデータの削除

**GCPでは:** Cloud Scheduler + Cloud Run Jobs

### パターン2: 何かが起きたら動かす（イベント駆動）

「〇〇が起きたら、△△する」というパターン。

```
ユーザーが画像をアップロード
↓
┌─────────────┐
│ バッチ処理  │
│             │
│ 「サムネイル│
│  を作成」   │
└─────────────┘
```

**使う場面:**
- 画像アップロード → サムネイル生成
- 注文確定 → 在庫を減らす
- ユーザー登録 → ウェルカムメール送信

**GCPでは:** Cloud Pub/Sub + Cloud Run

### パターン3: 後回しにする（キュー）

「今すぐやらなくていいから、後でやっておいて」というパターン。

```
API: 「メール送信お願い」
        ↓ キューに入れる
┌─────────────────────┐
│ キュー（待ち行列）  │
│ [メール1][メール2]  │
└─────────────────────┘
        ↓ 順番に処理
┌─────────────┐
│ バッチ処理  │
│ 「メール送信」│
└─────────────┘
```

**使う場面:**
- メール送信（すぐ送らなくてもいい）
- 外部APIの呼び出し（レート制限がある）
- 重い処理を後回しにしたい

**GCPでは:** Cloud Tasks + Cloud Run

---

## バッチ処理で大事なこと

### 大事なこと1: 冪等性（べきとうせい）

難しそうな言葉ですが、意味は簡単です。

> **何回やっても結果が同じになること**

#### なぜ大事？

バッチ処理は失敗することがあります。
失敗したらもう一度やり直します（リトライ）。

```
❌ 冪等性がない場合:

1回目: ポイント100を「追加」 → 残高 100
2回目: ポイント100を「追加」 → 残高 200  ← 二重に増えた！

ネットワークエラーでリトライしたら、ポイントが2倍に...
```

```
✅ 冪等性がある場合:

1回目: ポイントを「100に設定」 → 残高 100
2回目: ポイントを「100に設定」 → 残高 100  ← 変わらない

何回やっても安全
```

#### 冪等にするコツ

**コツ1: 「追加」ではなく「設定」にする**

```sql
-- ❌ 追加（冪等じゃない）
UPDATE users SET point = point + 100

-- ✅ 設定（冪等）
UPDATE users SET point = 100
```

**コツ2: 処理済みをスキップする条件を入れる**

```sql
-- ❌ 全員を無効化（冪等じゃない...というか既に無効の人も処理してしまう）
UPDATE users SET is_active = false WHERE last_login < '2024-01-01'

-- ✅ まだ有効な人だけ無効化（冪等）
UPDATE users SET is_active = false
WHERE last_login < '2024-01-01'
  AND is_active = true  ← これがポイント
```

2回目に実行しても、`is_active = true` の人はもういないので何も起きない。

**コツ3: 処理IDを記録する**

```
処理ID: 2024-01-15-daily-batch

1回目: 処理ID を記録して実行
2回目: 処理ID が既にある → スキップ
```

---

### 大事なこと2: エラー処理

バッチ処理は夜中に動くことが多い。
失敗しても誰も気づかない可能性がある。

#### 失敗したらどうする？

**自動リトライ:**
```
1回目: 失敗（ネットワークエラー）
  ↓ 1秒待つ
2回目: 失敗（まだダメ）
  ↓ 2秒待つ
3回目: 成功！
```

**通知:**
```
3回リトライしても失敗
  ↓
Slack に通知「バッチが失敗しました」
  ↓
担当者が確認
```

#### 終了コード

バッチ処理の結果は「終了コード」で表します。

```
終了コード 0 = 成功
終了コード 1 = 失敗
```

```go
func main() {
    err := runBatch()
    if err != nil {
        log.Println("失敗:", err)
        os.Exit(1)  // 失敗
    }
    os.Exit(0)  // 成功
}
```

Cloud Run Jobs はこの終了コードを見て、失敗したらリトライしてくれます。

---

### 大事なこと3: ログを残す

バッチ処理は人が見ていない間に動く。
何が起きたかわかるように、ログを残すことが大事。

#### 良いログの例

```
[2024-01-15 03:00:00] バッチ開始: 非アクティブユーザー無効化
[2024-01-15 03:00:01] 対象ユーザー: 150人
[2024-01-15 03:00:05] 処理完了: 150人を無効化しました
```

#### 悪いログの例

```
[2024-01-15 03:00:00] 開始
[2024-01-15 03:00:05] 完了
```

何をしたのかわからない。何人処理したのかわからない。

---

## GCPでバッチ処理を動かす

### Cloud Run Jobs とは？

GCPでバッチ処理を動かすサービスです。

```
Cloud Run Service（API用）
├─ HTTPリクエストで起動
├─ ずっと動いている
└─ 例: Backend API, Frontend

Cloud Run Jobs（バッチ用）
├─ 手動 or スケジュールで起動
├─ 処理が終わったら止まる
└─ 例: 日次集計、ユーザー無効化
```

### なぜ Cloud Run Jobs？

```
✅ 処理が終わったら自動で止まる → 料金が安い
✅ 失敗したら自動でリトライ
✅ Cloud Scheduler と連携して定期実行
✅ コンテナなので開発環境と同じ環境で動く
```

### 料金の違い

```
Cloud Run Service:
- リクエストがなくてもインスタンスが起動していると課金
- 最小インスタンス0なら待機中は無料

Cloud Run Jobs:
- 実行している時間だけ課金
- 1日1回、5分のバッチなら月150分だけの課金
```

---

## まとめ

### バッチ処理とは

- まとめて処理すること
- 時間がかかる処理、定期的な処理に使う
- 夜中など負荷が少ない時間に動かすことが多い

### 動かし方

| パターン | 使う場面 | GCPサービス |
|---------|---------|------------|
| 定期実行 | 日次集計、月次処理 | Cloud Scheduler + Cloud Run Jobs |
| イベント駆動 | ファイルアップロード時など | Cloud Pub/Sub + Cloud Run |
| キュー | メール送信、後回し処理 | Cloud Tasks + Cloud Run |

### 大事なこと

1. **冪等性**: 何回やっても同じ結果になるように作る
2. **エラー処理**: 失敗したらリトライ、通知
3. **ログ**: 何をしたか記録を残す

---

## 次に読むドキュメント

- [ジョブ処理の実装ガイド](./10_batch_job_design.md) - このプロジェクトでの具体的な実装
- [Cloud Run Jobs セットアップ](../../docs/setup-cloud-run-jobs.md) - デプロイ手順
