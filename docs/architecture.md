# アーキテクチャ概要

このドキュメントでは、immortal-architecture-deploy プロジェクトの全体アーキテクチャを説明します。

---

## サービス構成（運用時）

実際にサービスが動作しているときの構成図です。

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            サービス構成（運用時）                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│                                                                                     │
│        ┌──────────────┐                                                            │
│        │              │                                                            │
│        │    User      │                                                            │
│        │  (Browser)   │                                                            │
│        │              │                                                            │
│        └──────┬───────┘                                                            │
│               │                                                                     │
│               │ HTTPS                                                               │
│               ▼                                                                     │
│   ┌───────────────────────────────────────────────────────────────────────────┐    │
│   │                         Google Cloud Platform                              │    │
│   │                                                                            │    │
│   │        ┌──────────────────────────────────────────────────────────┐       │    │
│   │        │                       Cloud Run                           │       │    │
│   │        │                                                           │       │    │
│   │        │   ┌─────────────────────────────────────────────────┐    │       │    │
│   │        │   │                  Frontend                        │    │       │    │
│   │        │   │               (Next.js :3000)                    │    │       │    │
│   │        │   │                                                  │    │       │    │
│   │        │   │  ┌────────────────┐    ┌────────────────────┐   │    │       │    │
│   │        │   │  │  Static Files  │    │   API Routes       │   │    │       │    │
│   │        │   │  │  (HTML/JS/CSS) │    │   /api/auth/*      │   │    │       │    │
│   │        │   │  │                │    │   (認証処理)        │   │    │       │    │
│   │        │   │  └────────────────┘    └─────────┬──────────┘   │    │       │    │
│   │        │   │                                  │              │    │       │    │
│   │        │   └──────────────────────────────────┼──────────────┘    │       │    │
│   │        │                                      │                   │       │    │
│   │        │   ┌─────────────────────────────────────────────────┐    │       │    │
│   │        │   │                  Backend                         │    │       │    │
│   │        │   │                (Go API :8080)                    │    │       │    │
│   │        │   │                                                  │    │       │    │
│   │        │   │  ┌────────────────────────────────────────────┐ │    │       │    │
│   │        │   │  │              REST API                       │ │    │       │    │
│   │        │   │  │  GET  /api/templates      - テンプレート一覧 │ │    │       │    │
│   │        │   │  │  GET  /api/notes          - ノート一覧       │ │    │       │    │
│   │        │   │  │  ...                                        │ │    │       │    │
│   │        │   │  └────────────────────────────────────────────┘ │    │       │    │
│   │        │   │                       │                         │    │       │    │
│   │        │   └───────────────────────┼─────────────────────────┘    │       │    │
│   │        │                           │                              │       │    │
│   │        └───────────────────────────┼──────────────────────────────┘       │    │
│   │                                    │                                      │    │
│   └────────────────────────────────────┼──────────────────────────────────────┘    │
│                                        │                                           │
│                                        │ PostgreSQL Protocol                       │
│                                        │ (SSL/TLS)                                 │
│                                        ▼                                           │
│   ┌───────────────────────────────────────────────────────────────────────────┐    │
│   │                                  Neon                                      │    │
│   │                          (Serverless PostgreSQL)                           │    │
│   │                                                                            │    │
│   │    ┌────────────────────────────────────────────────────────────────┐     │    │
│   │    │                        PostgreSQL                               │     │    │
│   │    │                                                                 │     │    │
│   │    │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │     │    │
│   │    │   │  users   │  │ accounts │  │templates │  │  notes   │      │     │    │
│   │    │   └──────────┘  └──────────┘  └──────────┘  └──────────┘      │     │    │
│   │    │                                                                 │     │    │
│   │    └────────────────────────────────────────────────────────────────┘     │    │
│   │                                                                            │    │
│   └────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│                                                                                     │
│        ┌──────────────────────────────────────────────────────────────────┐        │
│        │                         External Services                         │        │
│        │                                                                   │        │
│        │   ┌───────────────────────────────────────────────────────────┐  │        │
│        │   │                      Google OAuth                          │  │        │
│        │   │                                                            │  │        │
│        │   │  - ユーザー認証（ログイン）                                  │  │        │
│        │   │  - Frontend の /api/auth/* から呼び出し                     │  │        │
│        │   │                                                            │  │        │
│        │   └───────────────────────────────────────────────────────────┘  │        │
│        │                                                                   │        │
│        └──────────────────────────────────────────────────────────────────┘        │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 通信フロー

```
┌──────────┐         ┌──────────┐         ┌──────────┐         ┌──────────┐
│  Browser │         │ Frontend │         │ Backend  │         │   Neon   │
│          │         │ (Next.js)│         │ (Go API) │         │(Postgres)│
└────┬─────┘         └────┬─────┘         └────┬─────┘         └────┬─────┘
     │                    │                    │                    │
     │  1. ページアクセス   │                    │                    │
     │───────────────────▶│                    │                    │
     │                    │                    │                    │
     │  2. HTML/JS/CSS    │                    │                    │
     │◀───────────────────│                    │                    │
     │                    │                    │                    │
     │  3. API リクエスト  │                    │                    │
     │  (fetch)           │                    │                    │
     │───────────────────▶│                    │                    │
     │                    │                    │                    │
     │                    │  4. REST API       │                    │
     │                    │───────────────────▶│                    │
     │                    │                    │                    │
     │                    │                    │  5. SQL Query      │
     │                    │                    │───────────────────▶│
     │                    │                    │                    │
     │                    │                    │  6. Result         │
     │                    │                    │◀───────────────────│
     │                    │                    │                    │
     │                    │  7. JSON Response  │                    │
     │                    │◀───────────────────│                    │
     │                    │                    │                    │
     │  8. 画面更新        │                    │                    │
     │◀───────────────────│                    │                    │
     │                    │                    │                    │
```

### 各コンポーネントの役割

| コンポーネント | URL | 役割 |
|--------------|-----|------|
| **Frontend** | `https://frontend-xxx.run.app` | ユーザーインターフェース、認証処理 |
| **Backend** | `https://backend-xxx.run.app` | ビジネスロジック、データ操作 API |
| **Neon** | `ep-xxx.neon.tech` | データ永続化 |
| **Google OAuth** | `accounts.google.com` | ユーザー認証 |

### なぜ Frontend と Backend を分けているのか？

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          責務の分離                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Frontend (Next.js)                    Backend (Go)                        │
│   ┌─────────────────────────────┐      ┌─────────────────────────────┐     │
│   │                             │      │                             │     │
│   │  - UI/UX                    │      │  - ビジネスロジック          │     │
│   │  - ユーザー認証 (OAuth)     │      │  - データバリデーション      │     │
│   │  - クライアントサイド処理    │      │  - データベースアクセス      │     │
│   │  - SSR/SSG                  │      │  - 他サービス連携            │     │
│   │                             │      │                             │     │
│   │  TypeScript / React         │      │  Go / Echo                  │     │
│   │                             │      │                             │     │
│   └─────────────────────────────┘      └─────────────────────────────┘     │
│                                                                             │
│   メリット:                                                                 │
│   - 独立してスケーリング可能                                                │
│   - 技術選定の自由度（言語・フレームワーク）                                 │
│   - チーム分担が容易                                                        │
│   - 片方だけデプロイ可能                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## CI/CD 構成（デプロイ時）

コードを push したときのビルド・デプロイの流れです。

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              CI/CD 構成図                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                              GitHub                                          │  │
│   │  ┌─────────────────────────────────────────────────────────────────────┐    │  │
│   │  │                     immortal-architecture-deploy                     │    │  │
│   │  │                                                                      │    │  │
│   │  │   ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐  │    │  │
│   │  │   │ backend-clean│    │   frontend   │    │ .github/workflows/   │  │    │  │
│   │  │   │   (Go API)   │    │  (Next.js)   │    │   migration.yml      │  │    │  │
│   │  │   └──────┬───────┘    └──────┬───────┘    └──────────┬───────────┘  │    │  │
│   │  │          │                   │                       │              │    │  │
│   │  └──────────┼───────────────────┼───────────────────────┼──────────────┘    │  │
│   │             │                   │                       │                   │  │
│   └─────────────┼───────────────────┼───────────────────────┼───────────────────┘  │
│                 │                   │                       │                      │
│                 │ push (webhook)    │ push (webhook)        │ push                 │
│                 ▼                   ▼                       ▼                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                         Google Cloud Platform                                │  │
│   │                                                                              │  │
│   │   ┌──────────────────────────────────────────────────────────────────────┐  │  │
│   │   │                        Cloud Build                                    │  │  │
│   │   │                                                                       │  │  │
│   │   │  ┌─────────────────────┐         ┌─────────────────────┐             │  │  │
│   │   │  │   backend-deploy    │         │   frontend-deploy   │             │  │  │
│   │   │  │      トリガー        │         │       トリガー       │             │  │  │
│   │   │  │                     │         │                     │             │  │  │
│   │   │  │ Filter:             │         │ Filter:             │             │  │  │
│   │   │  │ backend-clean/**    │         │ frontend/**         │             │  │  │
│   │   │  └──────────┬──────────┘         └──────────┬──────────┘             │  │  │
│   │   │             │                               │                        │  │  │
│   │   └─────────────┼───────────────────────────────┼────────────────────────┘  │  │
│   │                 │                               │                           │  │
│   │                 ▼                               ▼                           │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                      Artifact Registry                               │   │  │
│   │   │                       (Docker Images)                                │   │  │
│   │   │                                                                      │   │  │
│   │   │    ┌───────────────────────┐    ┌───────────────────────┐           │   │  │
│   │   │    │  backend:latest       │    │  frontend:latest      │           │   │  │
│   │   │    │  backend:{commit}     │    │  frontend:{commit}    │           │   │  │
│   │   │    └───────────────────────┘    └───────────────────────┘           │   │  │
│   │   │                                                                      │   │  │
│   │   └──────────────────────────────────────────────────────────────────────┘   │  │
│   │                 │                               │                            │  │
│   │                 ▼                               ▼                            │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                          Cloud Run                                   │   │  │
│   │   │                                                                      │   │  │
│   │   │    ┌───────────────────────┐    ┌───────────────────────┐           │   │  │
│   │   │    │       backend         │    │       frontend        │           │   │  │
│   │   │    │    (Go API :8080)     │    │   (Next.js :3000)     │           │   │  │
│   │   │    │                       │    │                       │           │   │  │
│   │   │    │  ┌─────────────────┐  │    │  ┌─────────────────┐  │           │   │  │
│   │   │    │  │ Secret Manager  │  │    │  │ Secret Manager  │  │           │   │  │
│   │   │    │  │ - DATABASE_URL  │  │    │  │ - DATABASE_URL  │  │           │   │  │
│   │   │    │  │ - CLIENT_ORIGIN │  │    │  │ - BETTER_AUTH_* │  │           │   │  │
│   │   │    │  └─────────────────┘  │    │  │ - GOOGLE_*      │  │           │   │  │
│   │   │    │                       │    │  └─────────────────┘  │           │   │  │
│   │   │    └───────────┬───────────┘    └───────────┬───────────┘           │   │  │
│   │   │                │                            │                        │   │  │
│   │   └────────────────┼────────────────────────────┼────────────────────────┘   │  │
│   │                    │                            │                            │  │
│   └────────────────────┼────────────────────────────┼────────────────────────────┘  │
│                        │                            │                               │
│                        └────────────┬───────────────┘                               │
│                                     │                                               │
│                                     ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                               Neon                                           │  │
│   │                        (Serverless PostgreSQL)                               │  │
│   │                                                                              │  │
│   │    ┌────────────────────────────────────────────────────────────────────┐   │  │
│   │    │                         PostgreSQL                                  │   │  │
│   │    │                                                                     │   │  │
│   │    │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │  │
│   │    │  │     users       │  │    bookmarks    │  │     ...         │     │   │  │
│   │    │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │   │  │
│   │    │                                                                     │   │  │
│   │    └────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                              │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント説明

### アプリケーション

| コンポーネント | 技術 | 役割 |
|--------------|------|------|
| **Backend** | Go + Echo | REST API サーバー |
| **Frontend** | Next.js 16 | Web アプリケーション（SSR + クライアント） |

### インフラストラクチャ

| サービス | 役割 |
|---------|------|
| **Cloud Build** | Docker イメージのビルド、Cloud Run へのデプロイ |
| **Cloud Build トリガー** | GitHub の push を検知して自動実行 |
| **Artifact Registry** | Docker イメージの保存 |
| **Cloud Run** | コンテナのホスティング（サーバーレス） |
| **Secret Manager** | 機密情報（DB接続文字列、APIキーなど）の管理 |
| **Neon** | サーバーレス PostgreSQL データベース |

### CI/CD

| パイプライン | 実行環境 | トリガー | 実行内容 |
|-------------|---------|---------|---------|
| **backend-deploy** | Cloud Build | `backend-clean/**` の変更 | Backend を Cloud Run にデプロイ |
| **frontend-deploy** | Cloud Build | `frontend/**` の変更 | Frontend を Cloud Run にデプロイ |
| **migration** | GitHub Actions | `migrations/**` の変更 | DB マイグレーション実行 |

---

## デプロイフロー

### Cloud Run デプロイ（Cloud Build トリガー）

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Developer  │     │    GitHub    │     │ Cloud Build  │     │  Cloud Run   │
│              │     │              │     │              │     │              │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │                    │
       │  git push          │                    │                    │
       │───────────────────▶│                    │                    │
       │                    │                    │                    │
       │                    │  webhook           │                    │
       │                    │───────────────────▶│                    │
       │                    │                    │                    │
       │                    │                    │  1. docker build   │
       │                    │                    │─────────┐          │
       │                    │                    │         │          │
       │                    │                    │◀────────┘          │
       │                    │                    │                    │
       │                    │                    │  2. docker push    │
       │                    │                    │  (Artifact Reg.)   │
       │                    │                    │─────────┐          │
       │                    │                    │         │          │
       │                    │                    │◀────────┘          │
       │                    │                    │                    │
       │                    │                    │  3. gcloud run     │
       │                    │                    │     deploy         │
       │                    │                    │───────────────────▶│
       │                    │                    │                    │
       │                    │                    │    deployed        │
       │                    │                    │◀───────────────────│
       │                    │                    │                    │
```

### Migration（GitHub Actions）

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Developer  │     │    GitHub    │     │GitHub Actions│     │     Neon     │
│              │     │              │     │              │     │              │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │                    │
       │  git push          │                    │                    │
       │  (migrations/)     │                    │                    │
       │───────────────────▶│                    │                    │
       │                    │                    │                    │
       │                    │  trigger workflow  │                    │
       │                    │───────────────────▶│                    │
       │                    │                    │                    │
       │                    │                    │  paths-filter      │
       │                    │                    │  (detect changes)  │
       │                    │                    │─────────┐          │
       │                    │                    │         │          │
       │                    │                    │◀────────┘          │
       │                    │                    │                    │
       │                    │                    │  migrate up        │
       │                    │                    │───────────────────▶│
       │                    │                    │                    │
       │                    │                    │    success         │
       │                    │                    │◀───────────────────│
       │                    │                    │                    │
```

---

## ディレクトリ構成

```
immortal-architecture-deploy/
├── backend-clean/               # Backend (Go API)
│   ├── cmd/api/                 # エントリーポイント
│   ├── internal/                # ビジネスロジック
│   ├── migrations/              # DB マイグレーション (golang-migrate)
│   ├── Dockerfile               # 本番用 Dockerfile
│   ├── cloudbuild.yaml          # Cloud Build 設定
│   └── docs/
│       └── 09_cloud_run_deploy.md
│
├── frontend/                    # Frontend (Next.js)
│   ├── src/                     # ソースコード
│   ├── drizzle/                 # DB マイグレーション (Drizzle)
│   ├── Dockerfile               # 本番用 Dockerfile
│   ├── cloudbuild.yaml          # Cloud Build 設定
│   └── docs/
│       └── 01_cloud_run_deploy.md
│
├── .github/workflows/           # GitHub Actions
│   └── migration.yml            # Migration ワークフロー
│
└── docs/
    └── architecture.md          # このドキュメント
```

---

## 環境変数

### Backend

| 変数名 | 説明 | 管理方法 |
|-------|------|---------|
| `DATABASE_URL` | Neon PostgreSQL 接続文字列 | Secret Manager |
| `CLIENT_ORIGIN` | Frontend の URL（CORS 設定用） | Secret Manager |
| `PORT` | サーバーポート（8080） | Cloud Run 自動設定 |

### Frontend

| 変数名 | 説明 | 管理方法 |
|-------|------|---------|
| `DATABASE_URL` | Neon PostgreSQL 接続文字列 | Secret Manager |
| `BETTER_AUTH_SECRET` | Better Auth のシークレットキー | Secret Manager |
| `BETTER_AUTH_URL` | OAuth コールバック用 URL | 環境変数 |
| `GOOGLE_CLIENT_ID` | Google OAuth クライアント ID | Secret Manager |
| `GOOGLE_CLIENT_SECRET` | Google OAuth シークレット | Secret Manager |
| `NEXT_PUBLIC_APP_URL` | クライアント側 URL | ビルド時埋め込み |

---

## 使用技術まとめ

### 言語・フレームワーク

| 領域 | 技術 |
|-----|------|
| Backend | Go 1.25, Echo |
| Frontend | Next.js 16, React, TypeScript |
| Database | PostgreSQL (Neon) |
| ORM | GORM (Backend), Drizzle (Frontend) |
| 認証 | Better Auth, Google OAuth |

### インフラ・DevOps

| 領域 | 技術 |
|-----|------|
| コンテナ | Docker |
| CI/CD | Cloud Build, GitHub Actions |
| ホスティング | Cloud Run |
| シークレット管理 | Secret Manager |
| コンテナレジストリ | Artifact Registry |
| データベース | Neon (Serverless PostgreSQL) |

---

## 関連ドキュメント

- [Backend デプロイガイド](../backend-clean/docs/09_cloud_run_deploy.md)
- [Frontend デプロイガイド](../frontend/docs/01_cloud_run_deploy.md)
