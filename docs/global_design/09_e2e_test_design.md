# E2Eテスト設計書

## 概要

本ドキュメントでは、フロントエンドのE2E（End-to-End）テストの設計方針、テストケースの選定理由、および実装ガイドラインを定義する。

## テストツール

### Playwright を選択した理由

1. **Next.js との親和性**: Vercel 公式推奨のE2Eテストフレームワーク
2. **モダンな機能**: 自動待機、ネットワークインターセプト、複数ブラウザ対応
3. **開発体験**: UI モード、トレース、スクリーンショットなどデバッグ機能が充実
4. **パフォーマンス**: 並列実行、ヘッドレスモードによる高速なテスト実行

## テストの分類と目的

### テストピラミッドにおける位置づけ

```
        /\
       /  \     E2E テスト（少）: ユーザーフロー全体の動作確認
      /----\
     /      \   統合テスト（中）: コンポーネント間の連携確認
    /--------\
   /          \ ユニットテスト（多）: 個別関数・フックの動作確認
  /------------\
```

E2Eテストは実行コストが高いため、**クリティカルパス**に絞って実装する。

### E2Eテストの目的

1. **ユーザー視点での動作確認**: 実際のブラウザでユーザーと同じ操作を行う
2. **統合動作の検証**: フロントエンド・バックエンド・DBが連携して正しく動作することを確認
3. **回帰テスト**: デプロイ前に既存機能が壊れていないことを確認

## テストケース設計

### 選定基準

E2Eテストのケースは以下の基準で選定する：

| 優先度 | 基準 | 例 |
|--------|------|-----|
| 高 | 認証・認可に関わる機能 | 未認証リダイレクト |
| 中 | ログインUI表示 | ログインページ、OAuthボタン |

### E2Eテストの対象範囲

本プロジェクトでは、Google OAuthを使用しているため、E2Eテストは**未認証状態でのアクセス制御（リダイレクト）の検証**に限定する。

認証済み状態でのCRUD操作（ノート作成、テンプレート編集など）は、以下の理由からE2Eテストの対象外とする：

1. **OAuth認証の自動化が困難**: Googleの外部ページ遷移を含むため、自動テストでの再現が難しい
2. **テストの信頼性**: 外部サービス依存によりフレーキーテストになりやすい
3. **コスト対効果**: 認証済みフローはユニットテストと手動テストで十分カバー可能

### テストケース一覧

#### 1. 認証フロー（auth.spec.ts）

| テストケース | 目的 |
|--------------|------|
| ログインページ表示 | ログインUIが正しく表示されることを確認 |
| Googleログインボタン表示 | OAuthボタンが表示・有効であることを確認 |
| 未認証リダイレクト（/notes） | 保護されたページへのアクセス制御を確認 |
| 未認証リダイレクト（/templates） | 保護されたページへのアクセス制御を確認 |
| 未認証リダイレクト（/my-notes） | 保護されたページへのアクセス制御を確認 |
| トップページリダイレクト | 未認証時にログインページへリダイレクトされることを確認 |

#### 2. テンプレート機能（template.spec.ts）

| テストケース | 目的 |
|--------------|------|
| 未認証リダイレクト（/templates） | 一覧ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/templates/new） | 新規作成ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/templates/:id） | 詳細ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/templates/:id/edit） | 編集ページへの未認証アクセスでリダイレクト |

#### 3. ノート機能（note.spec.ts）

| テストケース | 目的 |
|--------------|------|
| 未認証リダイレクト（/notes） | みんなのノート一覧への未認証アクセスでリダイレクト |
| 未認証リダイレクト（/my-notes） | マイノート一覧への未認証アクセスでリダイレクト |
| 未認証リダイレクト（/notes/new） | 新規作成ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/my-notes/new） | 新規作成ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/notes/:id） | 詳細ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/my-notes/:id） | 詳細ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/notes/:id/edit） | 編集ページへの未認証アクセスでリダイレクト |
| 未認証リダイレクト（/my-notes/:id/edit） | 編集ページへの未認証アクセスでリダイレクト |

## 認証済みフローのテスト戦略

認証が必要な機能（CRUD操作など）は、E2Eテストではなく以下の方法でカバーする：

| 機能 | テスト方法 | テストファイル |
|------|-----------|---------------|
| フォームバリデーション | ユニットテスト | `schema.test.ts` |
| カスタムフック | ユニットテスト | `useXxx.test.ts` |
| Server Actions | ユニットテスト | `*.action.test.ts` |
| API連携 | 統合テスト（バックエンド） | `*_test.go` |
| CRUD操作全体 | 手動テスト | - |

## 実装ガイドライン

### セレクタの優先順位

1. **Role ベース**（推奨）: `getByRole("button", { name: "作成" })`
2. **Label ベース**: `getByLabel("タイトル")`
3. **Placeholder ベース**: `getByPlaceholder("検索...")`
4. **Text ベース**: `getByText("テンプレート")`
5. **Test ID**（最終手段）: `getByTestId("submit-button")`

**理由**: アクセシビリティに優れ、UIの変更に強いセレクタを優先する。

### アサーションの書き方

```typescript
// Good: 明示的な待機とアサーション
await expect(page).toHaveURL(/\/login/);

// Bad: 固定時間の待機
await page.waitForTimeout(1000);
```

## テスト実行

### コマンド

```bash
# 全テスト実行
pnpm test:e2e

# UI モードで実行（デバッグ用）
pnpm test:e2e:ui

# 特定のファイルのみ実行
pnpm test:e2e auth.spec.ts

# ヘッドありモードで実行（ブラウザを表示）
pnpm test:e2e -- --headed
```

### CI/CD での実行

```yaml
# GitHub Actions の例
- name: Run E2E tests
  run: pnpm test:e2e
  env:
    CI: true
```

CI環境では全18テストが自動実行される。

## まとめ

E2Eテストは「未認証ユーザーが保護されたリソースにアクセスできないこと」を検証する目的で設計されている。

- **テスト対象**: 未認証状態でのリダイレクト確認（18テスト）
- **テスト対象外**: 認証済み状態でのCRUD操作（ユニットテスト・手動テストでカバー）

Google OAuth依存により認証済みフローの自動テストが困難なため、テストピラミッドの考え方に従い、E2Eテストは最小限に抑え、ユニットテストで広くカバーする戦略を採用している。
